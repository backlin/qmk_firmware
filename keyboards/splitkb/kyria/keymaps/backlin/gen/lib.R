setwd("~/qmk_firmware/keyboards/kyria/keymaps/backlin/gen")

library(png)

font <- (readPNG("font.png")[,,1] > .9)

gp <- function(r, c) matrix(.5, nrow=r, ncol=c)

render <- function(keymap) {
  img <- Reduce(rbind, lapply(keymap, function(page){
    page <- c(page, rep(32, 36-length(page)))
    Reduce(cbind, lapply(page, function(char){
      r <- 1:8 + 8 * (char%/%16)
      c <- 1:7 + 7 * (char%%16)
      if(any(r > nrow(font))){
        stop(sprintf("char %i -> row %i\n", char, r))
      }
      if(any(c > ncol(font))){
        stop(sprintf("char %i -> col %i\n", c))
      }
      font[r, c]
    }))
  }))
  
  img <- cbind(gp(64, 5), 0, img[,1:126], 0, gp(64, 32), 0, img[,127:252], 0, gp(64, 5))
  img <- rbind(gp(5, ncol(img)), img, gp(5, ncol(img)))
  image(t(img[nrow(img):1,]), col=grey(0:2/2), ann=FALSE, axes=FALSE)
}

trim_trailing_space <- function(chars){
  non_space <- which(chars != 32)
  if(length(non_space) == 0) return(NULL)
  chars[1:max(non_space)]
}

max_line_length <- 18

write_side <- function(lines, name, file) {
	# Add newline if line is shorter than 18 characters.
	# Add null char to last line.
  lines <- Map(
    function(line, newline, nullchar){
      line <-c(trim_trailing_space(line), newline)
      page <- c(line[1:min(length(line), max_line_length)], nullchar)
      page[!is.na(page)]
    },
    lines,
    as.list(rep(c(10, NA), c(length(lines)-1, 1))),
    as.list(rep(c(NA,  0), c(length(lines)-1, 1)))
  )
  
  cat(file=file, append=TRUE, sprintf(
"// generated by Makefile
static void render_%s(void) {
  static const char PROGMEM %s[] = {
    %s,
  };
  oled_write_P(%s, false);
}\n\n",
    name,
    name,
    paste(sapply(lines, paste, collapse=", "), collapse=",\n    "),
    name
  ))
}

write <- function(layers, file="render_layers.c") {
  cat("", file=file)
  for(i in seq_along(layers)){
    name <- names(layers)[i]
    layer <- layers[[i]]
    write_side(lapply(layer, "[", 1:18),  paste0(name, "_left"), file=file)
    write_side(lapply(layer, "[", 19:36), paste0(name, "_right"), file=file)
  }
}
